<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Picture</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="javascripts/utilities.js"></script>
</head>
<body>
    <div id="navbar-container"></div>

    <!-- Centered main area. Adjust min-height to account for navbar height -->
    <main class="d-flex align-items-center justify-content-center" style="min-height: calc(100vh - 56px);">
        <div class="card shadow-sm p-4" style="width: 560px; max-width: 95%;">
            <h1 class="h4 text-center mb-3">Upload a Picture</h1>
            <form action="/upload" method="post" enctype="multipart/form-data">
                <label for="location" class="form-label">Location:</label>
                <input type="hidden" id="token" name="token" value="">
                <script>
                (function(){
                    try {
                        const tokenInput = document.getElementById('token');
                        tokenInput.value = getToken();
                        const form = tokenInput.closest('form');
                        form?.addEventListener('submit', () => {
                            tokenInput.value = getToken();
                        });
                    } catch (e) {
                        console.warn('Could not read token from sessionStorage', e);
                    }
                })();
                </script>   
                <input class="form-control mb-2" type="text" id="location" name="location" placeholder="Enter location" required>
                <div class="d-flex gap-2 mb-3">
                    <button type="button" class="btn btn-outline-secondary" onclick="getLocation()">Use Current Location</button>
                </div>
                <script>
                    function getLocation() {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(function(position) {
                        const latitude = position?.coords?.latitude;
                        const longitude = position?.coords?.longitude;
                        if (latitude == null || longitude == null) {
                            alert('Unable to retrieve valid location coordinates. Please enter manually.');
                            return;
                        }
                        document.getElementById('location').value = `Lat: ${latitude}, Long: ${longitude}`;
                        }, function(error) {
                        alert('Unable to retrieve location. Please enter manually.');
                        });
                    } else {
                        alert('Geolocation is not supported by your browser.');
                    }
                    }
                </script>

                <div id="map" style="height: 300px; width: 100%;" class="mb-3"></div>
                <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
                <script>
                    const map = L.map('map', {
                        center: [-20.720, -42.400],
                        zoom: 11,
                        zoomControl: false
                    });

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19,
                    }).addTo(map);

                    let marker;

                    map.on('click', function(e) {
                        const { lat, lng } = e.latlng;
                        if (marker) {
                            marker.setLatLng(e.latlng);
                        } else {
                            marker = L.marker(e.latlng).addTo(map);
                        }
                        document.getElementById('location').value = `Lat: ${lat}, Long: ${lng}`;
                    });
                </script>

                <label for="picture" class="form-label">Choose a picture:</label>
                <input class="form-control mb-3" type="file" id="picture" name="picture" accept="image/*" required>
                <label for="tag-input" class="form-label">Tags:</label>
                <div class="mb-2">
                    <div id="tags-list" class="d-flex flex-wrap gap-1 mb-2"></div>
                    <div class="input-group">
                        <input id="tag-input" class="form-control" list="tag-suggestions" placeholder="Add a tag and press Enter or comma">
                        <button type="button" id="add-tag-btn" class="btn btn-outline-secondary">Add</button>
                    </div>
                    <datalist id="tag-suggestions">
                        <option value="animal"></option>
                        <option value="planta"></option>
                        <option value="paisagem"></option>
                    </datalist>
                    <input type="hidden" name="tags" id="tags-hidden" value="">
                    <div class="form-text">Separate multiple tags by pressing Enter or comma. Click a tag to remove it.</div>
                </div>

                <script>
                (function(){
                    const input = document.getElementById('tag-input');
                    const addBtn = document.getElementById('add-tag-btn');
                    const tagsList = document.getElementById('tags-list');
                    const hidden = document.getElementById('tags-hidden');

                    let tags = [];

                    function renderTags() {
                        tagsList.innerHTML = '';
                        tags.forEach((t, idx) => {
                            const span = document.createElement('span');
                            span.className = 'badge bg-secondary text-white px-2 py-1';
                            span.style.cursor = 'pointer';
                            span.textContent = t;
                            span.title = 'Click to remove';
                            span.addEventListener('click', () => {
                                tags.splice(idx, 1);
                                updateHidden();
                                renderTags();
                            });
                            tagsList.appendChild(span);
                        });
                    }

                    function normalizeTag(tag) {
                        return tag.trim().toLowerCase();
                    }

                    function addTagFromValue(val) {
                        if (!val) return;
                        // split by commas to support pasted lists
                        const parts = val.split(',').map(normalizeTag).filter(Boolean);
                        let changed = false;
                        parts.forEach(p => {
                            if (!tags.includes(p)) {
                                tags.push(p);
                                changed = true;
                            }
                        });
                        if (changed) {
                            updateHidden();
                            renderTags();
                        }
                    }

                    function updateHidden() {
                        hidden.value = tags.join(',');
                    }

                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ',') {
                            e.preventDefault();
                            addTagFromValue(input.value);
                            input.value = '';
                        }
                        if (e.key === 'Backspace' && input.value === '' && tags.length) {
                            // remove last tag on backspace when input empty
                            tags.pop();
                            updateHidden();
                            renderTags();
                        }
                    });

                    input.addEventListener('blur', () => {
                        // on blur, commit whatever is typed
                        addTagFromValue(input.value);
                        input.value = '';
                    });

                    addBtn.addEventListener('click', () => {
                        addTagFromValue(input.value);
                        input.value = '';
                        input.focus();
                    });

                    // expose a helper to set initial tags if needed
                    window.setInitialTags = function(initialArray) {
                        if (Array.isArray(initialArray)) {
                            tags = initialArray.map(normalizeTag).filter(Boolean)
                                .filter((v, i, arr) => arr.indexOf(v) === i);
                            updateHidden();
                            renderTags();
                        }
                    };

                    renderTags();
                })();
                </script>
                <div class="d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>
            </form>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</body>
</html>